document.addEventListener("DOMContentLoaded", function () {
    const studentsData = {
        "students": [
            {
    "student_id": "z822790z6A",
    "name": "Afia Anjum Aboni",
    "institution": "institution",
    "category": "Junior",
    "year": "1999",
    "research_proposal_title": "The Relevance of Class Disparity in the Implementation of Climate-Related Policies; an Investigation into the Different Socioeconomic Classes of Dhaka",
    "research_paper": {
      "research_problem": 17,
      "existing_literature": 7,
      "research_question": 20,
      "methodology": 18,
      "research_topic": 12,
      "quality_of_writing": 4,
      "plagiarism_check_percentile": 0.03,
      "presentation": {
        "persuasiveness": 30,
        "video_quality": 16,
        "research_problem": 4.03,
        "research_question": 30.03,
        "methodology": 46
      }
    }
  },
  {
    "student_id": "5Z92Z85473",
    "name": "Adira Safwan",
    "institution": "institution",
    "category": "Junior",
    "year": "1999",
    "research_proposal_title": "Exploring Differences in Social Media Literacy Between Digital Natives and Digital Immigrants: A Comparative Analysis of Critical Skills and Digital Adaptability",
    "research_paper": {
      "research_problem": 14,
      "existing_literature": 4,
      "research_question": 17,
      "methodology": 15,
      "research_topic": 11,
      "quality_of_writing": 2,
      "plagiarism_check_percentile": 0.17,
      "presentation": {
        "persuasiveness": 26,
        "video_quality": 13,
        "research_problem": 2.17,
        "research_question": 26.17,
        "methodology": 39
      }
    }
  },
  {
    "student_id": "z865aAzA3a",
    "name": "Adnan Hussain Sajeeb",
    "institution": "institution",
    "category": "Junior",
    "year": "1999",
    "research_proposal_title": "Anti-Deepfake Biometrics:\r\nProtecting Identity in the Digital World",
    "research_paper": {
      "research_problem": 18,
      "existing_literature": 8,
      "research_question": 22,
      "methodology": 19,
      "research_topic": 14,
      "quality_of_writing": 4,
      "plagiarism_check_percentile": 0,
      "presentation": {
        "persuasiveness": 33,
        "video_quality": 18,
        "research_problem": 4,
        "research_question": 33,
        "methodology": 51
      }
    }
  },
  {
    "student_id": "3270776100",
    "name": "Andi Filzah Dahiyah Liana",
    "institution": "institution",
    "category": "Junior",
    "year": "1999",
    "research_proposal_title": "Effectiveness Test of Silica Gel from Rice Husk and \r\nCoffee Grounds as Adsorbent",
    "research_paper": {
      "research_problem": 15,
      "existing_literature": 6,
      "research_question": 17,
      "methodology": 17,
      "research_topic": 12,
      "quality_of_writing": 3,
      "plagiarism_check_percentile": 0.1,
      "presentation": {
        "persuasiveness": 29,
        "video_quality": 15,
        "research_problem": 3.1,
        "research_question": 29.1,
        "methodology": 44
      }
    }
  },
  {
    "student_id": "72985AAa21",
    "name": "Arnob Kumar Sarkar",
    "institution": "institution",
    "category": "Junior",
    "year": "1999",
    "research_proposal_title": "Evaluating and Implementing Integrated Waste Management Strategies in Mymensingh: A Pilot-Based Approach to Waste Segregation, Recycling, and Policy Optimization",
    "research_paper": {
      "research_problem": 17,
      "existing_literature": 6,
      "research_question": 20,
      "methodology": 18,
      "research_topic": 13,
      "quality_of_writing": 3,
      "plagiarism_check_percentile": 0.02,
      "presentation": {
        "persuasiveness": 31,
        "video_quality": 16,
        "research_problem": 3.02,
        "research_question": 31.02,
        "methodology": 47
      }
    }
  },
  {
    "student_id": "2019936zZ3",
    "name": "Ashura Tabassum Arshi",
    "institution": "institution",
    "category": "Junior",
    "year": "1999",
    "research_proposal_title": "Evaluating Combined Urban Heat Island Mitigation Strategies in Dhaka: A Mixed-Methods Approach to Address Existing Research Gaps and Enhance Community Sustainability.",
    "research_paper": {
      "research_problem": 18,
      "existing_literature": 7,
      "research_question": 21,
      "methodology": 19,
      "research_topic": 14,
      "quality_of_writing": 4,
      "plagiarism_check_percentile": 0.04,
      "presentation": {
        "persuasiveness": 33,
        "video_quality": 18,
        "research_problem": 4.04,
        "research_question": 33.04,
        "methodology": 51
      }
    }
  },
  {
    "student_id": "z559776A40",
    "name": "Nahian Adib Mahim",
    "institution": "institution",
    "category": "Junior",
    "year": "1999",
    "research_proposal_title": "Hypothesizing Dark Matter as Quantum States Encoded in Hidden Dimensions: A Quantum-Based Approach Towards Understanding Dark Matter and Its Properties",
    "research_paper": {
      "research_problem": 16,
      "existing_literature": 6,
      "research_question": 19,
      "methodology": 18,
      "research_topic": 14,
      "quality_of_writing": 4,
      "plagiarism_check_percentile": 0.05,
      "presentation": {
        "persuasiveness": 32,
        "video_quality": 18,
        "research_problem": 4.05,
        "research_question": 32.05,
        "methodology": 50
      }
    }
  },
  {
    "student_id": "AA8z42A366",
    "name": "Glory Jewel ",
    "institution": "institution",
    "category": "Junior",
    "year": "1999",
    "research_proposal_title": "A comprehensive study upon adolescence BMI and obesity rates.",
    "research_paper": {
      "research_problem": 15,
      "existing_literature": 5,
      "research_question": 18,
      "methodology": 17,
      "research_topic": 12,
      "quality_of_writing": 2,
      "plagiarism_check_percentile": 0.05,
      "presentation": {
        "persuasiveness": 29,
        "video_quality": 14,
        "research_problem": 2.05,
        "research_question": 29.05,
        "methodology": 43
      }
    }
  },
  {
    "student_id": "92Z2A0z0a2",
    "name": "Ha-mim Rahman",
    "institution": "institution",
    "category": "Junior",
    "year": "1999",
    "research_proposal_title": "Evaluating the Association Between Dietary Factors and Esophageal Cancer of Middle-Income Adults in Dhaka: A Case-Control Study Approach",
    "research_paper": {
      "research_problem": 17,
      "existing_literature": 7,
      "research_question": 20,
      "methodology": 19,
      "research_topic": 13,
      "quality_of_writing": 4,
      "plagiarism_check_percentile": 0.04,
      "presentation": {
        "persuasiveness": 32,
        "video_quality": 17,
        "research_problem": 4.04,
        "research_question": 32.04,
        "methodology": 49
      }
    }
  },
  {
    "student_id": "917570z9zZ",
    "name": "Xeon Nasif",
    "institution": "institution",
    "category": "Junior",
    "year": "1999",
    "research_proposal_title": "The Alteration of Lecture-Based Pedagogy Through Generative AI and a Proposed Ethical Framework for AI Detection Tools: A Mixed-Methods Study from the Perspectives of Students and Teachers in Secondary and Higher Secondary Education in Urban Bangladesh",
    "research_paper": {
      "research_problem": 18,
      "existing_literature": 7,
      "research_question": 21,
      "methodology": 19,
      "research_topic": 13,
      "quality_of_writing": 4,
      "plagiarism_check_percentile": 0.03,
      "presentation": {
        "persuasiveness": 32,
        "video_quality": 17,
        "research_problem": 4.03,
        "research_question": 32.03,
        "methodology": 49
      }
    }
  }
        ]
    };

    // Search function for students
    document.getElementById("search-btn").addEventListener("click", function () {
        const searchTerm = document.getElementById("student-search").value.toLowerCase();
        const student = studentsData.students.find(s => 
            s.name.toLowerCase().includes(searchTerm) || 
            s.student_id.toLowerCase().includes(searchTerm)
        );
        
        if (student) {
            generateScorecard(student);
        } else {
            alert("Student not found!");
        }
    });

    // Function to generate scorecard on the page
    function generateScorecard(student) {
        const container = document.getElementById("student-details");
        container.innerHTML = '';  // Clear previous content

        const { name, student_id, institution, category, year, research_proposal_title, research_paper } = student;
        const paperScores = research_paper;
        const presentationScores = paperScores.presentation;

        // Calculate final scores
        const totalScore = [
            { score: paperScores.research_problem, weight: 20 },
            { score: paperScores.existing_literature, weight: 10 },
            { score: paperScores.research_question, weight: 25 },
            { score: paperScores.methodology, weight: 25 },
            { score: paperScores.research_topic, weight: 15 },
            { score: paperScores.quality_of_writing, weight: 5 },
            { score: paperScores.plagiarism_check_percentile, weight: 5 }
        ].reduce((acc, { score, weight }) => acc + calculateWeightedScore(score, weight), 0);

        const presentationTotalScore = [
            { score: presentationScores.persuasiveness, weight: 20 },
            { score: presentationScores.video_quality, weight: 20 },
            { score: presentationScores.research_problem, weight: 20 },
            { score: presentationScores.research_question, weight: 20 },
            { score: presentationScores.methodology, weight: 20 }
        ].reduce((acc, { score, weight }) => acc + calculateWeightedScore(score, weight), 0);

        const finalTotalScore = totalScore + presentationTotalScore;
        const scaledFinalScore = (finalTotalScore / 250) * 100;

        // Create the HTML for the scorecard
        const scorecard = document.createElement("div");
        scorecard.classList.add("scorecard");

        scorecard.innerHTML = `
            <h2>Scorecard for ${name}</h2>
            <p><strong>Year:</strong> ${year}</p>
            <p><strong>Student ID:</strong> ${student_id}</p>
            <p><strong>Institution:</strong> ${institution}</p>
            <p><strong>Category:</strong> ${category}</p>
            <p><strong>Research Proposal Title:</strong> ${research_proposal_title}</p>
            
            <h3>Research Paper Evaluation</h3>
            <table>
                <thead>
                    <tr>
                        <th>Criteria</th>
                        <th>Marks Obtained</th>
                        <th>Weight</th>
                        <th>Weighted Score</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Research Problem</td>
                        <td>${paperScores.research_problem}</td>
                        <td>20%</td>
                        <td>${calculateWeightedScore(paperScores.research_problem, 20).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>Existing Literature</td>
                        <td>${paperScores.existing_literature}</td>
                        <td>10%</td>
                        <td>${calculateWeightedScore(paperScores.existing_literature, 10).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>Research Question</td>
                        <td>${paperScores.research_question}</td>
                        <td>25%</td>
                        <td>${calculateWeightedScore(paperScores.research_question, 25).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>Methodology</td>
                        <td>${paperScores.methodology}</td>
                        <td>25%</td>
                        <td>${calculateWeightedScore(paperScores.methodology, 25).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>Research Topic</td>
                        <td>${paperScores.research_topic}</td>
                        <td>15%</td>
                        <td>${calculateWeightedScore(paperScores.research_topic, 15).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>Quality of Writing</td>
                        <td>${paperScores.quality_of_writing}</td>
                        <td>5%</td>
                        <td>${calculateWeightedScore(paperScores.quality_of_writing, 5).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>Plagiarism Check</td>
                        <td>${paperScores.plagiarism_check_percentile}</td>
                        <td>5%</td>
                        <td>${calculateWeightedScore(paperScores.plagiarism_check_percentile, 5).toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>

            <h3>Presentation Evaluation</h3>
            <table>
                <thead>
                    <tr>
                        <th>Criteria</th>
                        <th>Marks Obtained</th>
                        <th>Weight</th>
                        <th>Weighted Score</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Persuasiveness</td>
                        <td>${presentationScores.persuasiveness}</td>
                        <td>20%</td>
                        <td>${calculateWeightedScore(presentationScores.persuasiveness, 20).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>Video Quality</td>
                        <td>${presentationScores.video_quality}</td>
                        <td>20%</td>
                        <td>${calculateWeightedScore(presentationScores.video_quality, 20).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>Research Problem</td>
                        <td>${presentationScores.research_problem}</td>
                        <td>20%</td>
                        <td>${calculateWeightedScore(presentationScores.research_problem, 20).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>Research Question</td>
                        <td>${presentationScores.research_question}</td>
                        <td>20%</td>
                        <td>${calculateWeightedScore(presentationScores.research_question, 20).toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>Methodology</td>
                        <td>${presentationScores.methodology}</td>
                        <td>20%</td>
                        <td>${calculateWeightedScore(presentationScores.methodology, 20).toFixed(2)}</td>
                    </tr>
                </tbody>
            </table>

            <h3>Total Score: ${finalTotalScore.toFixed(2)} / 250</h3>
            <h3>Scaled Score: ${scaledFinalScore.toFixed(2)} / 100</h3>

            <button id="download-pdf">Download Scorecard</button>
        `;

        container.appendChild(scorecard);

        // Event listener to download the scorecard as a PDF
        document.getElementById("download-pdf").addEventListener("click", function () {
            downloadPDF(student, finalTotalScore, scaledFinalScore);
        });
    }

    // Function to calculate the weighted score
    function calculateWeightedScore(score, weight) {
        return (score * weight) / 100;
    }

    // Function to download PDF with design
    function downloadPDF(student, finalTotalScore, scaledFinalScore) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Add the logo (replace with your logo file path)
        doc.addImage('logo.png', 'PNG', 10, 10, 50, 50);

        // Set font and title
        doc.setFont("Poppins", "normal");
        doc.setFontSize(14);
        doc.text(`Scorecard for ${student.name}`, 70, 20);
        doc.text(`Student ID: ${student.student_id}`, 70, 30);
        doc.text(`Institution: ${student.institution}`, 70, 40);
        doc.text(`Category: ${student.category}`, 70, 50);
        doc.text(`Year: ${student.year}`, 70, 60);
        doc.text(`Research Proposal Title: ${student.research_proposal_title}`, 70, 70);

        // Research Paper Scores
        doc.text("Research Paper Evaluation", 70, 90);
        addScoreTable(doc, 90, student.research_paper, finalTotalScore);

        // Presentation Scores
        doc.text("Presentation Evaluation", 70, 150);
        addScoreTable(doc, 150, student.research_paper.presentation, finalTotalScore);

        // Total and Scaled Score
        doc.text(`Total Score: ${finalTotalScore.toFixed(2)} / 250`, 70, 230);
        doc.text(`Scaled Score: ${scaledFinalScore.toFixed(2)} / 100`, 70, 240);

        // Save PDF
        doc.save(`${student.student_id}_scorecard.pdf`);
    }

    // Add a table of scores to PDF
    function addScoreTable(doc, startY, scores, finalScore) {
        const headers = ["Criteria", "Marks Obtained", "Weight", "Weighted Score"];
        const rows = [
            ["Research Problem", scores.research_problem, "20%", calculateWeightedScore(scores.research_problem, 20).toFixed(2)],
            ["Existing Literature", scores.existing_literature, "10%", calculateWeightedScore(scores.existing_literature, 10).toFixed(2)],
            ["Research Question", scores.research_question, "25%", calculateWeightedScore(scores.research_question, 25).toFixed(2)],
            ["Methodology", scores.methodology, "25%", calculateWeightedScore(scores.methodology, 25).toFixed(2)],
            ["Research Topic", scores.research_topic, "15%", calculateWeightedScore(scores.research_topic, 15).toFixed(2)],
            ["Quality of Writing", scores.quality_of_writing, "5%", calculateWeightedScore(scores.quality_of_writing, 5).toFixed(2)],
            ["Plagiarism Check", scores.plagiarism_check_percentile, "5%", calculateWeightedScore(scores.plagiarism_check_percentile, 5).toFixed(2)]
        ];

        doc.autoTable({
            head: [headers],
            body: rows,
            startY: startY,
            theme: 'grid',
            margin: { top: 10 },
            tableWidth: 'wrap',
        });
    }
});
